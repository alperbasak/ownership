name: CODEOWNERS Auto-Approve

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  pull-requests: write
  contents: read

jobs:
  auto-approve:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR author owns all files
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Read CODEOWNERS file
            let codeownersContent;
            const possiblePaths = ['.github/CODEOWNERS', 'CODEOWNERS', 'docs/CODEOWNERS'];
            
            for (const p of possiblePaths) {
              try {
                codeownersContent = fs.readFileSync(p, 'utf8');
                console.log(`Found CODEOWNERS at ${p}`);
                break;
              } catch (e) {
                // Try next path
              }
            }
            
            if (!codeownersContent) {
              console.log('No CODEOWNERS file found');
              return false;
            }
            
            // Parse CODEOWNERS
            const rules = [];
            const lines = codeownersContent.split('\n');
            
            for (const line of lines) {
              const trimmed = line.trim();
              if (!trimmed || trimmed.startsWith('#')) continue;
            
              const parts = trimmed.split(/\s+/);
              if (parts.length < 2) continue;
            
              const pattern = parts[0];
              const owners = parts.slice(1);
              rules.push({ pattern, owners });
            }
            
            // Get PR info
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const prAuthor = pr.user.login;
            console.log(`PR author: ${prAuthor}`);
            
            // Get changed files
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            // Helper function to check if user is in a team
            async function isUserInTeam(org, teamSlug, username) {
              try {
                await github.rest.teams.getMembershipForUserInOrg({
                  org: org,
                  team_slug: teamSlug,
                  username: username
                });
                return true;
              } catch (e) {
                return false;
              }
            }
            
            // Helper function to check if author is an owner
            async function isAuthorOwner(owner, author) {
              // Direct user match
              if (owner === `@${author}` || owner === author) {
                return true;
              }
            
              // Team match (format: @org/team-name)
              if (owner.startsWith('@') && owner.includes('/')) {
                const parts = owner.slice(1).split('/');
                if (parts.length === 2) {
                  const [org, teamSlug] = parts;
                  return await isUserInTeam(org, teamSlug, author);
                }
              }
            
              return false;
            }
            
            // Helper function to match patterns
            function matchesPattern(filepath, pattern) {
              let regexPattern = pattern
                .replace(/\./g, '\\.')
                .replace(/\*/g, '[^/]*')
                .replace(/\?/g, '[^/]');
            
              if (pattern.endsWith('/')) {
                regexPattern = regexPattern + '.*';
              }
            
              if (pattern.startsWith('/')) {
                regexPattern = '^' + regexPattern.slice(1);
              } else {
                regexPattern = '(^|/)' + regexPattern;
              }
            
              const regex = new RegExp(regexPattern + '$');
              return regex.test(filepath);
            }
            
            // Check if author owns ALL files
            let authorOwnsAll = true;
            const nonOwnedFiles = [];
            
            for (const file of files) {
              const filepath = file.filename;
            
              // Find matching rule (last match wins)
              let matchedOwners = [];
              for (const rule of rules) {
                if (matchesPattern(filepath, rule.pattern)) {
                  matchedOwners = rule.owners;
                }
              }
            
              if (matchedOwners.length > 0) {
                // Check if author is in any of the owner groups (users or teams)
                let authorOwnsFile = false;
                for (const owner of matchedOwners) {
                  if (await isAuthorOwner(owner, prAuthor)) {
                    authorOwnsFile = true;
                    break;
                  }
                }
            
                if (!authorOwnsFile) {
                  authorOwnsAll = false;
                  nonOwnedFiles.push(`${filepath} (owned by: ${matchedOwners.join(', ')})`);
                }
              }
            }
            
            if (authorOwnsAll) {
              console.log('✅ PR author owns all modified files');
            } else {
              console.log('❌ PR contains files not owned by author:');
              nonOwnedFiles.forEach(f => console.log(`  - ${f}`));
            }
            
            return authorOwnsAll;

      - name: Auto-approve if author owns all files
        if: steps.check.outputs.result == 'true'
        uses: hmarr/auto-approve-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
