name: CODEOWNERS Auto Approve

on:
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:
  auto-approve:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auto approve if author owns all files
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BOT_PAT }}
          script: |
            const fs = require('fs');
            
            // ============================================
            // 1. GET BASIC INFO
            // ============================================
            const { data: bot } = await github.rest.users.getAuthenticated();
            const author = context.payload.pull_request.user.login;
            const prNumber = context.payload.pull_request.number;
            
            console.log(`Bot: @${bot.login}`);
            console.log(`Author: @${author}`);
            console.log(`PR: #${prNumber}`);
            
            // ============================================
            // 2. GET CHANGED FILES
            // ============================================
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              per_page: 100
            });
            
            const changedFiles = files.map(f => f.filename);
            console.log(`Files changed: ${changedFiles.length}`);
            
            if (changedFiles.length === 0) {
              console.log('No files to check');
              return;
            }
            
            // ============================================
            // 3. LOAD CODEOWNERS
            // ============================================
            const codeownersPath = '.github/CODEOWNERS';
            if (!fs.existsSync(codeownersPath)) {
              console.log('No CODEOWNERS file found');
              return;
            }
            
            const rules = fs.readFileSync(codeownersPath, 'utf8')
              .split('\n')
              .filter(line => line.trim() && !line.startsWith('#'))
              .map(line => {
                const [pattern, ...owners] = line.trim().split(/\s+/);
                return { pattern, owners };
              })
              .filter(rule => rule.owners.length > 0);
            
            console.log(`CODEOWNERS rules: ${rules.length}`);
            
            // ============================================
            // 4. HELPER FUNCTIONS
            // ============================================
            
            // Check if username is in a GitHub team
            async function isInTeam(username, teamSlug) {
              try {
                const [org, team] = teamSlug.replace('@', '').split('/');
                if (!org || !team) return false;
            
                await github.rest.teams.getMembershipForUserInOrg({
                  org, team_slug: team, username
                });
                return true;
              } catch {
                return false;
              }
            }
            
            // Check if username is in the owners list (direct or via team)
            async function isOwner(username, owners) {
              for (const owner of owners) {
                if (owner === `@${username}`) return true;
                if (owner.includes('/') && await isInTeam(username, owner)) return true;
              }
              return false;
            }
            
            // Check if file matches CODEOWNERS pattern
            function matches(file, pattern) {
              if (pattern === '*') return true;
            
              // Normalize: remove leading slash from pattern for comparison
              const normalizedPattern = pattern.startsWith('/') ? pattern.slice(1) : pattern;
            
              // Directory pattern: /dir/ or /dir matches dir/*
              if (normalizedPattern.endsWith('/')) {
                const dir = normalizedPattern.slice(0, -1);
                return file.startsWith(dir + '/') || file === dir;
              }
            
              // Check if file starts with the pattern (for directory matches)
              if (file.startsWith(normalizedPattern + '/')) {
                return true;
              }
            
              // Exact match or glob pattern
              const regex = new RegExp(
                '^' + normalizedPattern.replace(/\./g, '\\.').replace(/\*/g, '.*') + '$'
              );
              return regex.test(file);
            }
            
            // Find owners for a file (LAST matching rule wins - CODEOWNERS behavior)
            function findOwners(file) {
              let owners = null;
              let pattern = null;
            
              // Iterate through ALL rules, last match wins
              for (const rule of rules) {
                if (matches(file, rule.pattern)) {
                  owners = rule.owners;
                  pattern = rule.pattern;
                }
              }
            
              return { owners, pattern };
            }
            
            // ============================================
            // 5. CHECK EACH FILE
            // ============================================
            console.log('\n--- Checking files ---');
            
            let shouldApprove = true;
            
            for (const file of changedFiles) {
              const { owners, pattern } = findOwners(file);
            
              if (!owners) {
                console.log(`${file}: no owners found`);
                continue;
              }
            
              const botIsOwner = await isOwner(bot.login, owners);
              const authorIsOwner = await isOwner(author, owners);
            
              console.log(`${file}:`);
              console.log(`  pattern: ${pattern}`);
              console.log(`  owners: ${owners.join(', ')}`);
              console.log(`  bot is owner: ${botIsOwner}`);
              console.log(`  author is owner: ${authorIsOwner}`);
            
              // Bot must be in owners to approve
              if (!botIsOwner) {
                console.log(`  ❌ Bot not authorized for this file`);
                console.log(`  Fix: Add @${bot.login} to pattern: ${pattern}`);
                shouldApprove = false;
                break;
              }
            
              // Author must own all files
              if (!authorIsOwner) {
                console.log(`  ⏸️  Author doesn't own this file`);
                shouldApprove = false;
              }
            }
            
            // ============================================
            // 6. APPROVE IF CONDITIONS MET
            // ============================================
            console.log('\n--- Decision ---');
            
            if (!shouldApprove) {
              console.log('❌ Not auto-approving');
              return;
            }
            
            console.log('✅ All conditions met, approving...');
            
            try {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                event: 'APPROVE',
                body: '✅ Auto-approved: All changes are owned by @' + author
              });
              console.log('✅ PR approved');
            } catch (error) {
              if (error.status === 422) {
                console.log('Already approved or same user');
              } else {
                throw error;
              }
            }
